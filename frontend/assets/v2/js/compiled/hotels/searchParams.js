// Generated by CoffeeScript 1.4.0
var HotelsSearchParams, SpRoom,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

SpRoom = (function() {

  function SpRoom(parent) {
    var _this = this;
    this.parent = parent;
    this.getParams = __bind(this.getParams, this);

    this.getHash = __bind(this.getHash, this);

    this.adults = ko.observable(2).extend({
      integerOnly: {
        min: 1,
        max: 4
      }
    });
    this.children = ko.observable(0).extend({
      integerOnly: {
        min: 0,
        max: 2
      }
    });
    this.ages = ko.observableArray();
    this.infants = ko.observable(0).extend({
      integerOnly: {
        min: 0,
        max: 2
      }
    });
    this.adults.subscribe(function(newValue) {
      if (newValue + _this.children() > 5) {
        _this.adults(5 - _this.children());
      }
      if ((_this.parent.overall() - _this.adults() + newValue) > 9) {
        return _this.adults(9 - _this.parent.overall() + _this.adults());
      }
    });
    this.children.subscribe(function(newValue) {
      var i, _i, _ref;
      if (newValue + _this.adults() > 5) {
        newValue = 5 - _this.adults();
        _this.children(newValue);
      }
      if ((_this.parent.overall() - _this.children() + newValue) > 9) {
        _this.children(9 - _this.parent.overall() + _this.children());
      }
      if (_this.ages().length === newValue) {
        return;
      }
      if (_this.ages().length < newValue) {
        for (i = _i = 0, _ref = newValue - _this.ages().length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
          _this.ages.push({
            age: ko.observable(12).extend({
              integerOnly: {
                min: 0,
                max: 12
              }
            })
          });
        }
      } else if (_this.ages().length > newValue) {
        _this.ages.splice(newValue);
      }
      return ko.processAllDeferredBindingUpdates();
    });
  }

  SpRoom.prototype.fromPEGObject = function(item) {
    var i, _i, _ref, _results;
    this.adults(item.adults);
    this.children(item.children);
    this.infants(item.infants);
    if (this.children() > 0) {
      _results = [];
      for (i = _i = 0, _ref = this.children() - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        _results.push(this.ages.push({
          age: ko.observable(item.ages[i]).extend({
            integerOnly: {
              min: 0,
              max: 12
            }
          })
        }));
      }
      return _results;
    }
  };

  SpRoom.prototype.fromObject = function(item) {
    var i, _i, _ref, _results;
    this.adults(item.adt);
    this.children(item.chd);
    this.infants(item.cots);
    if (this.children() > 0) {
      _results = [];
      for (i = _i = 0, _ref = this.children() - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        _results.push(this.ages.push({
          age: ko.observable(item.chdAges[i]).extend({
            integerOnly: {
              min: 0,
              max: 12
            }
          })
        }));
      }
      return _results;
    }
  };

  SpRoom.prototype.getHash = function() {
    var age, parts, _i, _len, _ref;
    parts = [this.adults(), this.children(), this.infants()];
    _ref = this.ages();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      age = _ref[_i];
      parts.push(age.age());
    }
    return parts.join(':');
  };

  SpRoom.prototype.getParams = function(i) {
    var ageObj, j, params, _i, _len, _ref;
    params = [];
    j = 0;
    _ref = this.ages();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      ageObj = _ref[_i];
      params.push(("rooms[" + i + "][chdAges][" + j + "]=") + ageObj.age());
      j++;
    }
    if (!params.length) {
      params.push("rooms[" + i + "][chdAges]=0");
    }
    params.push(("rooms[" + i + "][adt]=") + this.adults());
    params.push(("rooms[" + i + "][chd]=") + this.children());
    params.push(("rooms[" + i + "][cots]=") + this.infants());
    return params;
  };

  return SpRoom;

})();

HotelsSearchParams = (function(_super) {

  __extends(HotelsSearchParams, _super);

  function HotelsSearchParams() {
    this.GAData = __bind(this.GAData, this);

    this.GAKey = __bind(this.GAKey, this);

    this.getParams = __bind(this.getParams, this);

    this.url = __bind(this.url, this);

    this.fromObject = __bind(this.fromObject, this);

    this.fromPEGObject = __bind(this.fromPEGObject, this);

    this.fromString = __bind(this.fromString, this);

    this.hash = __bind(this.hash, this);

    var _this = this;
    this.city = ko.observable('');
    this.checkIn = ko.observable(false);
    this.checkOut = ko.observable(false);
    this.rooms = ko.observableArray([new SpRoom(this)]);
    this.hotelId = ko.observable(false);
    this.urlChanged = ko.observable(false);
    this.hotelChanged = ko.observable(false);
    this.overall = ko.computed(function() {
      var result, room, _i, _len, _ref;
      result = 0;
      _ref = _this.rooms();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        room = _ref[_i];
        result += room.adults();
        result += room.children();
      }
      return result;
    });
  }

  HotelsSearchParams.prototype.hash = function() {
    var hash, parts, room, _i, _len, _ref;
    parts = [this.city(), moment(this.checkIn()).format('D.M.YYYY'), moment(this.checkOut()).format('D.M.YYYY')];
    _ref = this.rooms();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      room = _ref[_i];
      parts.push(room.getHash());
    }
    hash = 'hotels/search/' + parts.join('/') + '/';
    return hash;
  };

  HotelsSearchParams.prototype.fromString = function(data) {
    data = PEGHashParser.parse(data, 'HOTELS');
    return this.fromPEGObject(data);
  };

  HotelsSearchParams.prototype.fromPEGObject = function(data) {
    var beforeUrl, hotelIdBefore, pair, r, room, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
    beforeUrl = this.url();
    hotelIdBefore = this.hotelId();
    this.city(data.to);
    this.checkIn(data.dateFrom);
    this.checkOut(data.dateTo);
    this.rooms.splice(0);
    this.hotelId(false);
    this.rooms([]);
    _ref = data.rooms;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      room = _ref[_i];
      room = new SpRoom(this);
      room.fromPEGObject(room);
      this.rooms.push(room);
    }
    this.hotelId(false);
    if (data.extra) {
      _ref1 = data.extra;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        pair = _ref1[_j];
        if (pair.key === 'hotelId') {
          this.hotelId(pair.value);
        }
      }
    }
    _ref2 = data.rooms;
    for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
      room = _ref2[_k];
      r = new SpRoom(this);
      r.fromPEGObject(room);
      this.rooms.push(r);
    }
    if (beforeUrl === this.url()) {
      this.urlChanged(false);
      if (hotelIdBefore === this.hotelId()) {
        return this.hotelChanged(false);
      } else {
        return this.hotelChanged(true);
      }
    } else {
      this.urlChanged(true);
      return this.hotelChanged(false);
    }
  };

  HotelsSearchParams.prototype.fromObject = function(data) {
    var item, r, _i, _len, _ref, _results;
    this.city(data.city);
    this.checkIn(moment(data.checkIn, 'YYYY-M-D').toDate());
    this.checkOut(moment(data.checkIn, 'YYYY-M-D').add('days', data.duration).toDate());
    this.rooms.splice(0);
    _ref = data.rooms;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      item = _ref[_i];
      r = new SpRoom(this);
      r.fromObject(item);
      _results.push(this.rooms.push(r));
    }
    return _results;
  };

  HotelsSearchParams.prototype.url = function() {
    var params, result;
    result = "hotel/search?";
    params = this.getParams();
    return result += params.join("&");
  };

  HotelsSearchParams.prototype.getParams = function(include_type) {
    var i, params, room, _i, _len, _ref;
    if (include_type == null) {
      include_type = false;
    }
    params = [];
    if (include_type) {
      params.push('type=hotel');
    }
    params.push('city=' + this.city());
    params.push('checkIn=' + moment(this.checkIn()).format('YYYY-M-D'));
    params.push('duration=' + moment(this.checkOut()).diff(moment(this.checkIn()), 'days'));
    _ref = this.rooms();
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      room = _ref[i];
      params.push.apply(params, room.getParams(i));
    }
    return params;
  };

  HotelsSearchParams.prototype.GAKey = function() {
    return this.city();
  };

  HotelsSearchParams.prototype.GAData = function() {
    var passangers, result, room, _i, _len, _ref;
    result = "1";
    passangers = [0, 0, 0];
    _ref = this.rooms();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      room = _ref[_i];
      passangers[0] += room.adults();
      passangers[1] += room.children();
      passangers[2] += room.infants();
    }
    result += ", " + passangers.join(" - ");
    result += ", " + moment(this.checkIn()).format('D.M.YYYY') + ' - ' + moment(this.checkOut()).format('D.M.YYYY');
    result += ", " + moment(this.checkIn()).diff(moment(), 'days') + " - " + moment(this.checkOut()).diff(moment(this.checkIn()), 'days');
    return result;
  };

  return HotelsSearchParams;

})(RoomsContainerMixin);

implement(HotelsSearchParams, ISearchParams);

implement(HotelsSearchParams, IRoomsContainer);
