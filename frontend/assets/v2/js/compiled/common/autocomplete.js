// Generated by CoffeeScript 1.4.0
var _this = this;

ko.bindingHandlers.autocomplete = {
  init: function(element, valueAccessor) {
    $(element).bind("focus", function() {
      return $(element).select();
    });
    $(element).typeahead({
      name: 'cities-' + valueAccessor().name,
      limit: 5,
      prefetch: '/js/cities.json',
      remote: window.apiEndPoint + "helper/autocomplete/" + valueAccessor().source + '/query/%QUERY',
      template: '<div title="{{value}}"><span class="city">{{name}}, </span><span class="country">{{country}}</span><span class="code">{{code}}</span></div>',
      engine: Hogan
    });
    $(element).on('typeahead:selected typeahead:autocompleted', function(e, data) {
      valueAccessor().iata(data.code);
      valueAccessor().readable(data.name);
      valueAccessor().readableGen(data.nameGen);
      valueAccessor().readableAcc(data.nameAcc);
      valueAccessor().readablePre(data.namePre);
      $(element).val(data.name);
      return $(element).parent().siblings('input.input-path').val(data.value + ', ' + data.country);
    });
    $(element).on('typeahead:over', function(e, data) {
      return $(element).parent().siblings('input.input-path').val(data.value + ', ' + data.country);
    });
    return $(element).on('typeahead:reset', function(e) {
      return $(element).parent().siblings('input.input-path').val('');
    });
  },
  update: function(element, valueAccessor) {
    var content, iataCode;
    iataCode = valueAccessor().iata();
    content = valueAccessor().readable();
    if (content === void 0) {
      content = '';
    }
    return _.each($(element).typeahead("setQueryInternal", content).data('ttView').datasets, function(dataset) {
      return dataset.getOneSuggestion(iataCode, function(s) {
        var data;
        if (s.length > 0) {
          data = s[0].datum;
          valueAccessor().readable(data.name);
          valueAccessor().readableGen(data.nameGen);
          valueAccessor().readableAcc(data.nameAcc);
          valueAccessor().readablePre(data.namePre);
          if ($(element).val().length === 0) {
            $(element).val(data.name);
            return $(element).parent().siblings('input.input-path').val(data.value + ', ' + data.country);
          }
        }
      });
    });
  }
};
